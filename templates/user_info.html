{% extends "base.html" %}
{% block title %} {{ user.fname }}'s Info {% endblock %}
{% block content %}
<h1> {{ user.fname }} {{ user.lname }} </h1>

<p> Favorite book: {{ user.fav_book }} </p>

{% if user.is_description_public or session.get("user_id") == user.user_id %}
<p> Description: {{ user.description }} </p>
{% endif %}

{% if user.is_fav_author_public or session.get("user_id") == user.user_id %}
<p> Favorite authors: <ul>{% for fav_author in user.fav_authors %} 
    <li> <a href="/author/{{fav_author.author.author_id}}">{{ fav_author.author.author_name }}</a> </li>
{% endfor %}
</ul></p>
{% endif %}
{% if user.is_fav_series_public or session.get("user_id") == user.user_id %}
<p> Favorite series: <ul>{% for fs in user.fav_series %} 
    <li><a href="/series/{{fs.series.series_id}}"> {{ fs.series.series_name }}</a> </li>
{% endfor %}
</ul></p>
{% endif %}

{% if session.get("user_id") == user.user_id %}
{% if not user.is_goodreads_authorized %}
<a href="/goodreads-oauth"><img src="/static/img/goodreads-login-button.png"></a>
{% endif %}
<div id="search-history">
<h3> Search History </h3>
<table class="table table-striped table-bordered">
    <thead>
    <tr>
        <th scope="col"> Date Searched </th>
        <th scope="col"> Timeframe </th>
        <th scope="col"> Search Term </th>
        <th scope="col"> Most Recently Released </th>
        <th scope="col"> Search Result </th>
    </tr>
</thead>
<tbody>
    {% for item in session.get("search_history") %}
    <tr>
        <td> {{ item[0] }} </td>
        <td> {{ item [1] }} </td>
        <td> {{ item[2] }} </td>
        <td> {{ item[3][0] }}, publication date: {{ item[3][1] }} </td>
        {% if item[4][1]%}
         <td> {{ item[4][0] }}, publication date: {{ item[4][1] }} </td>

        {% else %}
         <td> No results found </td>
        {% endif %}
    </tr>
    {% endfor %}
</tbody>

    </table>
</div>
<button class="btn" id="send-search-history"> Send Search History To Email </button>
 <div class="row">  
<div class="col-md-4">

<h3> Update Profile </h3>
<!--Another thing which I neeed to think about... how to update profile (and database!) without changing the page. I think I can AJAX it, but let's first try to get that set up without AJAX -->

<form action="/update-profile" method="POST">
<input type="hidden" name="user_id" value="{{ user.user_id }}">
Update description: <br><textarea name="description"></textarea><br>
Update favorite book: <input type="text" name="fav-book"><br>
Display description publicly: 
<input type="radio" name="descr-publ" value="1"> Yes <input type="radio" name="descr-publ" value="0"> No <br>
Display favorite series publicly:<input type="radio" name="fs-publ" value="1"> Yes <input type="radio" name="fs-publ" value="0"> No <br>
Display favorite authors publicly: <input type="radio" name="fa-publ" value="1"> Yes <input type="radio" name="fa-publ" value="0"> No <br>
<input type="Submit" value="Update">
</form>
</div>
<div class="col-md-4">
<h3> Update Favorite Authors </h3>
<form action="/update-authors" method="POST">
<input type="hidden" name="user_id" value="{{ user.user_id }}">
Check any authors you would like to remove: <br>{% for fav_author in user.fav_authors %}
<input type="checkbox" name="author-remove" value="{{ fav_author.author_id}}"> {{ fav_author.author.author_name }}<br> {% endfor %}<br>
List the authors you would like to add on a new line:<br>
<textarea name="new-author"></textarea><br>
<input type="Submit" value="Update">
</form>
</div>
<div class="col-md-4">
<h3> Update Favorite Series </h3>
<form action="/update-series" method="POST">
<input type="hidden" name="user_id" value="{{ user.user_id }}">
Check any series you would like to remove: <br>{% for fs in user.fav_series %}
<input type="checkbox" name="series-remove" value="{{ fs.series_id}}"> {{ fs.series.series_name }}<br> {% endfor %}<br>
Please select which series you would like to add: <br>
{% for s in series %}
<input type="checkbox" name="series-add" value="{{ s.series_id }}"> {{ s.series_name }} </br>
{% endfor %}
<input type="Submit" value="Update">
</form>
</div>
</div>
{% endif %}
{% endblock %}
{% block script %}
<script>
$("#send-search-history").on("click", function(){
    let title = 'Your Search History';
    let searchHistory = $("#search-history").html();
    let formInputs = {"title": title, "result": searchHistory};
    $.post("/email-info.json", formInputs, function(results){
        alert(results["status"]);
    })
})
</script>
{% endblock %}